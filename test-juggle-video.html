<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Juggle count test</title>
  <link href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css" rel="stylesheet">
  <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
  <style>
    body { font-family: roboto, system-ui, sans-serif; margin: 2em; color: #3d3d3d; --mdc-theme-primary: #007f8b; --mdc-theme-on-primary: #f1f3f4; }
    body.live-active { margin: 0; }
    #webcamButton { min-width: fit-content; padding-left: 1.25em; padding-right: 1.25em; white-space: nowrap; }
    video { display: block; width: 100%; height: 100%; object-fit: contain; transform: rotateY(180deg); -webkit-transform: rotateY(180deg); -moz-transform: rotateY(180deg); }
    section { opacity: 1; transition: opacity 500ms ease-in-out; }
    .mdc-button.mdc-button--raised.removed { display: none; }
    .invisible { opacity: 0.2; }
    .videoView { position: relative; width: 100%; }
    .videoView__button-wrap { width: 100%; text-align: center; padding-top: 1rem; }
    .videoView__button-wrap.removed { display: none; }
    .videoView.live-fullscreen { position: fixed; inset: 0; width: 100%; height: 100%; margin: 0; background: #000; display: flex; align-items: center; justify-content: center; z-index: 100; }
    .video-stage { position: relative; flex-shrink: 0; }
    .highlighter { background: none; border: 5px solid #cd32b8; border-radius: 50%; z-index: 1; position: absolute; box-sizing: border-box; }
    .juggle-count { position: absolute; top: 12px; left: 50%; transform: translateX(-50%); display: inline-block; padding: 8px 16px; font-size: 1.5rem; font-weight: bold; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.8); background: rgba(0,0,0,0.6); border-radius: 6px; z-index: 3; }
    .juggle-count.hidden { display: none; }
    .timing-stats { display: none; }
    .live-fullscreen .timing-stats { display: inline-flex; position: fixed; bottom: 0; left: 0; flex-wrap: wrap; gap: 0.75rem; font-size: 12px; color: #fff; background: rgba(0,0,0,0.6); padding: 6px 10px; border-radius: 4px 4px 0 0; z-index: 3; }
    .snake-frame { position: fixed; left: 0; right: 0; bottom: calc(2.5rem + 5px); width: 100%; height: 20vh; pointer-events: none; z-index: 2; }
    .snake-dot { position: absolute; width: 5px; height: 5px; border-radius: 50%; background: #2563eb; box-sizing: border-box; pointer-events: none; }
    .snake-dot-calculated { background: #f80320; }
    .snake-dot-juggle { width: 10px; height: 10px; background: #2feb25; }
    .snake-dot-label { position: absolute; left: 50%; transform: translateX(-50%); font-size: 10px; line-height: 1.2; white-space: nowrap; background: #ffffffb3; padding: 2px 4px; border-radius: 2px; box-shadow: 0 1px 2px rgba(0,0,0,0.2); pointer-events: none; }
    .snake-dot-label-top { bottom: 100%; margin-bottom: 4px; }
    .snake-dot-label-bottom { top: 100%; margin-top: 4px; }
    #testResult { position: fixed; top: 0; left: 0; z-index: 9999; background: #fff; padding: 8px 12px; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
    #testPanel { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10000; display: flex; flex-direction: column; align-items: center; gap: 12px; }
    #testPanel.hidden { display: none; }
    #runTestBtn { padding: 12px 24px; font-size: 1.25rem; cursor: pointer; }
    #testControls { display: flex; align-items: center; }
    #testControls label { cursor: pointer; user-select: none; }
  </style>
</head>
<body>
  <div id="testResult">Loading…</div>
  <div id="testPanel" class="hidden">
    <button type="button" id="runTestBtn">Run test</button>
    <div id="testControls">
      <label>
        <input type="checkbox" id="debugModeCheckbox" />
        Enable DEBUG mode
      </label>
    </div>
  </div>
  <section id="demos" class="invisible">
    <div id="liveView" class="videoView">
      <div id="webcamButtonWrap" class="videoView__button-wrap">
        <button id="webcamButton" class="mdc-button mdc-button--raised">
          <span class="mdc-button__ripple"></span>
          <span class="mdc-button__label">Start juggle count</span>
        </button>
      </div>
      <div id="videoStage" class="video-stage">
        <video id="webcam" playsinline></video>
        <div id="juggleCount" class="juggle-count hidden" aria-live="polite">0 juggles</div>
        <div id="timingStats" class="timing-stats" aria-live="polite">
          <span id="aiMs">AI: — ms</span>
          <span id="postAiMs">PostAI: — ms</span>
          <span id="totalMsFps">Total: — ms / — FPS</span>
        </div>
      </div>
    </div>
  </section>

  <script type="module" src="js/app.js"></script>
  <script type="module">
    const VIDEO_URL = 'test.mp4';
    const EXPECTED_JUGGLES = 10;

    window.addEventListener('juggleAppReady', () => {
      const resultEl = document.getElementById('testResult');
      const runBtn = document.getElementById('runTestBtn');
      resultEl.textContent = 'Loading video…';
      try {
        const { start, result } = window.runJuggleTest(VIDEO_URL);
        window.addEventListener('juggleTestReadyToRun', () => {
          resultEl.textContent = 'Click "Run test" to start (required by browser).';
          document.getElementById('testPanel').classList.remove('hidden');
          runBtn.onclick = () => {
            document.getElementById('testPanel').classList.add('hidden');
            resultEl.textContent = 'Running…';
            const debugMode = document.getElementById('debugModeCheckbox').checked;
            start(debugMode);
            result.then((actualJuggles) => {
              const pass = actualJuggles === EXPECTED_JUGGLES;
              resultEl.textContent = pass ? 'PASS' : `FAIL: expected ${EXPECTED_JUGGLES}, got ${actualJuggles}`;
              resultEl.style.color = pass ? 'green' : 'red';
            }).catch((e) => {
              resultEl.textContent = 'ERROR: ' + e.message;
              resultEl.style.color = 'red';
            });
          };
        }, { once: true });
      } catch (e) {
        resultEl.textContent = 'ERROR: ' + e.message;
        resultEl.style.color = 'red';
      }
    }, { once: true });
  </script>
</body>
</html>
